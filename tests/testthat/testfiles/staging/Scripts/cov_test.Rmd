---
title: "Theophylline covariate model development"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r setup, include=F}
## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
library(rprojroot)
library(knitr)
opts_chunk$set(echo=F)
opts_knit$set(root.dir=find_root(has_file(".Rprofile")))
opts_chunk$set(echo = TRUE)

```

This document was created by `r Sys.info()['user']` at `r Sys.time()` in `r getwd()` using `r R.version.string`.

```{r message=FALSE, results='hide'}
library(future)
future::plan("future::multiprocess", workers = 2)
library(NMprojectAZ)
library(dplyr)
devtools::load_all("~/NMproject/")
load_localpackage()

module_cmd("module load psn")
```

## Base model fit

```{r message=FALSE, results='hide'}

c1 <- nm2(run_id = "c1") %>%
  ctl("staging/Models/run1.mod") %>%
  cmd("qpsn -t 100 -r 1000 -- execute {ctl_name} -dir={run_dir}") %>%
  data_path("DerivedData/THEOPcov1.csv") %>%
  fill_input()

#nm_tran(c1)

c1 <- c1 %>% run_nm() %>% wait_finish(timeout = 5*60)

```

```{r}
## do a diagnostic

c1 %>% gof_ggplot2()

## build covariate model

#stage("/projects/qcp/QCP_MODELING/ONC/azd6094/poppk_20181203_pk-eff-ae-interim3/localpackage/R/sim_reest_funs.R") %>%
#  import()

kable(summary_long(c1, parameters = "all"))

saveRDS(c1, "Results/base_model_pk.RDS")

```

## Define testing relationships

```{r}
dtest <- test_relations(param = c("KA", "K", "V"),
                        cov = c("LIN1", "LIN2", "LIN3", "RND1", "RND2", "RND3"), 
                        state = c("linear", "power"), 
                        continuous = TRUE) %>%
  test_relations(param = c("KA", "K", "V"),
                 cov = "BN1",
                 state = "linear",
                 continuous = FALSE)

kable(dtest)

```

### 1st step forward

```{r message=FALSE, results='hide'}

dsc1 <- c1 %>% covariate_step_setup(run_id = "c1_f1",
                                    dtest = dtest,
                                    direction = "forward")

#nm_tran(dsc1$m)

dsc1$m <- dsc1$m %>% run_nm() %>% wait_finish(timeout = 60*60)

dsc1 <- dsc1 %>% bind_covariate_results()

```

```{r}
kable(dsc1 %>% select(-m, -location))

## diagnostics

dsc1$m[1:3] <- dsc1$m[1:3] %>%
  nmsave_plot(gof_ggplot2(.), 
              plot_name = "diag_{run_id}.pdf")


## no condition number

#dsc1$m[1] %>% show_out() ## covariance step failed

c1_f1 <- dsc1$m[3]
stopifnot(run_id(c1_f1) == "c1_f1_V_LIN3_linear")

c1_f1 %>% gof_ggplot2()

```

Decision: V - LIN3 -linear
- most significant
- decent gofs

### 2nd step forward

```{r message=FALSE, results='hide'}
dsc2 <- c1_f1 %>% covariate_step_setup(run_id = "c1_f2",
                                       dtest = dtest,
                                       direction = "forward")

dsc2$m <- dsc2$m %>% run_nm() %>% wait_finish(timeout = 60*60)

dsc2 <- dsc2 %>% bind_covariate_results()

```

```{r}
kable(dsc2 %>% select(-m, -location))

dsc2$m[1:3] <- dsc2$m[1:3] %>%
  nmsave_plot(gof_ggplot2(.), 
              plot_name = "diag_{run_id}.pdf")

#dsc2$m[1:3] %>% find_result_files("diag") #%>% file.show()

c1_f2 <- dsc2$m[1]

stopifnot(run_id(c1_f2) == "c1_f2_KA_LIN1_power")

c1_f2 %>% gof_ggplot2()

```

decision: KA LIN1 power
- most significant even though cov step failed

## 1st back ward step


```{r message=FALSE, results='hide'}
dsc3 <- c1_f2 %>% covariate_step_setup(run_id = "c1_f2_b1",
                                       dtest = dtest,
                                       direction = "backward")
#nm_tran(dsc3$m)

dsc3$m <- dsc3$m %>% run_nm() %>% wait_finish(timeout = 60*60)

dsc3 <- dsc3 %>% bind_covariate_results()
```

```{r}

kable(dsc3 %>% select(-m, -location))


```

Both covariates still significant. End of covariate testing

```{r}
final_model <- c1_f2

kable(summary_long(final_model, parameters = "all"))

final_model %>% gof_ggplot2()

final_model %>% text

saveRDS(final_model, "Results/final_model_pk.RDS")

```

```{r}

final_model %>% cov_forest_plot()

```

```{r}
final_model %>% param_cov_diag(param = "V", cov = "LIN3", categorical = FALSE)

```

```{r}
final_model %>% param_cov_diag(param = "KA", cov = "LIN1", categorical = FALSE)

```

```{r message=FALSE, results='hide'}
d <- tibble(sim = 1:10)
d$run_id <- paste0("s", d$sim)

d$m <- final_model %>% child(run_id = d$run_id) %>%
  update_parameters(final_model) %>%
  run_in("Models/ppc_final1") %>%
  convert_to_simulation(seed = d$sim)

d <- {
  d %>% mutate(m = m %>% run_nm() %>% wait_finish())
}

```

Define statistic function for computing exposures


```{r}

EXPstat <- function(d){ ## example statistic function
  ## arg = nonmem dataset data.frame 
  ## return data.frame with statistic column

  d <- d %>% mutate(
    LIN1_bin = Hmisc::cut2(LIN1, g = 3),
    LIN3_bin = Hmisc::cut2(LIN3, g = 3)
  )
  
  levels(d$LIN1_bin) <- c("LIN1_low", "LIN1_mid", "LIN1_upp")
  levels(d$LIN3_bin) <- c("LIN3_low", "LIN3_mid", "LIN3_upp")
  
  d %>%
    group_by(ID, LIN1_bin, LIN3_bin) %>% filter(is.na(AMT)) %>%
    summarise(
      AUC = AUC(time = TIME, conc = DV),
      CMAX = max(DV, na.rm = TRUE),
      TMAX = TIME[which.max(DV)]
    ) %>% 
    group_by(LIN1_bin, LIN3_bin) %>%
    summarise_at(c("AUC", "CMAX", "TMAX"), median, na.rm = TRUE) %>%
    tidyr::gather(AUC:TMAX, key = "type", value = "statistic")
}

```

Basic whisker plot - with 2 factors

```{r}
dppc <- d$m %>% ppc_data(EXPstat)
dppc %>% ppc_whisker_plot(type, LIN1_bin, LIN3_bin)
```

Only AUCs from ppc_data output and added layers to the plot

```{r}
dppc %>% filter(type %in% "AUC") %>%
  ppc_whisker_plot(LIN1_bin, LIN3_bin) +
  ylab("AUC") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


With multiple factors is sometimes necessary to hold some fixed.  The following set LIN3 to be it's median prior to statistic calculation.


```{r}
dppc <- d$m %>% ppc_data(
  EXPstat, LIN3 = median(input_data(final_model)$LIN3)
)

dppc %>% filter(type %in% "AUC") %>%
  ppc_histogram_plot(LIN1_bin) +
  xlab("AUC")
```

