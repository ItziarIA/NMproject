---
title: "NONMEM/PsN/qpsn/R testing"
output:
  pdf_document: default
  html_notebook: default
---

```{r setup, include=F}
## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
library(rprojroot)
library(knitr)
opts_chunk$set(echo=F)
opts_knit$set(root.dir=find_root(has_file("OpenProject.Rproj")))
opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE,message=FALSE}
library(NMprojectAZ)
load("Results/res.Rdata")
```


## Introduction

The purpose of these tests is to test basic function of NONMEM, PsN, R and supporting scripts in AZ's High Performance Computing infrastructure.

### Requirements

There is currently no formal requirements document however the following constitutes a draft list from which tests are defined:

#### NONMEM

NONMEM must be able to perform:

- Population PK analyses (closed form and ODE based)
- Population PK/PD analysis for continuous and categorical endpoints
- All supported estimation methods should work as expected
- MPI parallelisation

#### PsN

PsN must be able to perform:

- Model execution
- Bootstrap
- Stepwise covariate method (SCM)
- VPC
- SSE

#### R

R must be able to:

- Read in NONMEM/PsN outputs.
- Produce basic goodness of fit diagnostics

## Testing plan

The testing plan is designed to provide a *reasonable* degree of assurance that the system accomplishes its intended requirements.

### Tests

List of tests and assessment criteria

- Bootstrap
- Stepwise covariate method (SCM)
- VPC
- SSE

#### Model execution tests

For each run, NONMEM will be executed via qpsn.  For each NONMEM run:

- OFV will be extracted from the psn.ext file using R
- basic goodness of fit diagnostics will be produced using R
- convergence diagnostics will be produced using R

Here is a list of tests, with assessment criteria list as sub-bullets:

1. (*run1.mod*) Theophylline PK (NONMEM installation test):
    - concordance of estimated OFV with vendor provided value
 
2. (*run2.mod*) Theophylline PK IMP:
    - approximate concordance of estimated OFV with run 1.
    - approximate concordance of basic goodness of fit diagnostics with run 1.

3. (*run3.mod*) Theophylline PK SAEM:
    - approximate concordance of estimated OFV with run 1.
    - approximate concordance of basic goodness of fit diagnostics with run 1.

4. (*run4.mod*) Theophylline PK IMP ODE:
    - close concordance of estimated OFV with run 2.
    - close concordance of convergence diagnostics with run 2.
    - close concordance of basic goodness of fit diagnostics with run 2.
    
5. (*run5.mod*) Theophylline PK IMP (larger dataset = THEOPPlarge.csv)
    - concordance of parameter estimates with run 2
    - concordance of basic goodness of fit diagnostics with run 2 but with larger file size.

6. (*run6.mod*) Theophylline PK IMP (larger dataset = THEOPPlarge.csv) parallelised with "-c auto"
    - Number of cores selected
    - concordance of OFV with run 5
    - concordance of basic goodness of fit diagnostics as run 5
    - consistency of results under repetition (repeat test 5 times concurrently)

7. (*run7.mod*) Theophylline PK-continuous PD IMP (larger dataset = THEOPPlarge.csv using simulated continuous PD) parallelised
    - concordance of parameter estimates with simulated values
    - basic goodness of fit diagnostics split by endpoint
   
8. (*run8.mod*) Theophylline PK-continuous PD IMP (larger dataset = THEOPPlarge.csv using simulated bernoulli PD)
    - concordance of parameter estimates with simulated values
    - basic goodness of fit diagnostics split by endpoint

9. (*run9.mod*) Theophylline PK-continuous PD IMP (larger dataset = THEOPPlarge.csv using simulated time to event PD)
    - concordance of parameter estimates with simulated values
    - basic goodness of fit diagnostics split by endpoint

#### Bootstrap tests

1. (*run2.mod*) Bootstrap -samples=10
    - raw results produced with 10 rows
    - boostrap_results produced


## Results

Manual instructions:

1. See tables below - run command in "cmd"
2. After running open Models/XX/raw_results_runXX.csv where XX is the number of the run
3. See "ofv" & "model_run_time" fields. If there are errors, these need debugging.


### Model execution results

1. (*run1.mod*) Theophylline PK (NONMEM installation test):
    - concordance of estimated OFV with vendor provided value

```{r echo=FALSE}
kable(res1)
```
 
2. (*run2.mod*) Theophylline PK IMP:
    - approximate concordance of estimated OFV with run 1.
    - approximate concordance of basic goodness of fit diagnostics with run 1.

```{r echo=FALSE}
kable(res2)
```

3. (*run3.mod*) Theophylline PK SAEM:
    - approximate concordance of estimated OFV with run 1.
    - approximate concordance of basic goodness of fit diagnostics with run 1.

```{r echo=FALSE}
kable(res3)
```

4. (*run4.mod*) Theophylline PK IMP ODE:
    - close concordance of estimated OFV with run 2.
    - close concordance of convergence diagnostics with run 2.
    - close concordance of basic goodness of fit diagnostics with run 2.
    
```{r echo=FALSE}
kable(res4)
```
 
5. (*run5.mod*) Theophylline PK IMP (larger dataset = THEOPPlarge.csv)
    - concordance of parameter estimates with run 2
    - concordance of basic goodness of fit diagnostics with run 2 but with larger file size.
    
```{r echo=FALSE}
kable(res5)
```

6. (*run6.mod*) Theophylline PK IMP (larger dataset = THEOPPlarge.csv) parallelised with "-c auto"
    - Number of cores selected
    - concordance of OFV with run 5
    - concordance of basic goodness of fit diagnostics as run 5
    - consistency of results under repetition (repeat test 5 times concurrently)
    
```{r echo=FALSE}
kable(res[[1]])
kable(res[[2]])
kable(res[[3]])
kable(res[[4]])
kable(res[[5]])
```

7. (*run7.mod*) Theophylline PK-continuous PD IMP (larger dataset = THEOPPlarge.csv using simulated continuous PD) parallelised
    - concordance of parameter estimates with simulated values
    - basic goodness of fit diagnostics split by endpoint

```{r echo=FALSE}
kable(res7)
```  

8. (*run8.mod*) Theophylline PK-continuous PD IMP (larger dataset = THEOPPlarge.csv using simulated bernoulli PD)
    - concordance of parameter estimates with simulated values
    - basic goodness of fit diagnostics split by endpoint

```{r echo=FALSE}
kable(res8)
```

9. (*run9.mod*) Theophylline PK-continuous PD IMP (larger dataset = THEOPPlarge.csv using simulated time to event PD)
    - concordance of parameter estimates with simulated values
    - basic goodness of fit diagnostics split by endpoint

### Bootstrap tests

1. (*run2.mod*) Bootstrap -samples=10
    - raw results produced with 10 rows
    - boostrap_results produced


