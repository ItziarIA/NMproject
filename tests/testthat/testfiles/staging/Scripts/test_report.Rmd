---
title: "Risk Reduction/GxP-lite: qualification of NONMEM/PsN/qpsn/RStudio/NMproject/SCP infrastructure for pharmacometric work"
output:
  pdf_document: default
  html_notebook: default
params:
  level: 1
---

```{r setup, include=F}
## DO NOT MODIFY THIS BLOCK (unless you know what you're doing)
library(rprojroot)
library(knitr)
opts_chunk$set(echo=F)
opts_knit$set(root.dir=find_root(has_file(".Rprofile")))
opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE,message=FALSE}
library(NMprojectAZ)
devtools::load_all("~/NMproject")
```

This document was created by `r Sys.info()['user']` at `r Sys.time()` in `r getwd()` using `r R.version.string`.

This report can be reproduced with the following commands from the base activity directory:

## Instructions to reproduce this document via command line (with existing test directory)

- start putty/mobaxterm
- start a screen: `screen`
- navigate to analysis directory: `cd [base activity dir (see above)]`
- load R module e.g. `module load mro/3.5.1-foss-2017a`
- launch knitr macro: `Rscript -e "source('Scripts/macro.R')"`
- detach screen: `ctrl-A D`
- Wait a couple of hours...
- restore screen session: `screen -r`
- view output: `~/test_reports/test_reportXXXX.pdf`

## Instructions to reproduce this document via command line (from scratch)

- start putty/mobaxterm
- start a screen: `screen`
- load R module e.g. `module load mro/3.5.1-foss-2017a`
- launch knitr macro: `Rscript -e "NMprojectAZ::run_test('~/testXXX')"`
- detach screen: `ctrl-A D`
- Wait a couple of hours...
- restore screen session: `screen -r`
- view output: `~/test_reports/test_reportXXXX.pdf`

## Introduction

The purpose of these tests is to test basic function of NONMEM, PsN, R and supporting scripts in AZ's High Performance Computing infrastructure.

### Requirements

There is currently no formal requirements document however the following constitutes a draft list from which tests are defined:

#### NONMEM

NONMEM must be able to perform:

- Population PK analyses (closed form and ODE based)
- Population PK/PD analysis for continuous and categorical endpoints
- All supported estimation methods should work as expected
- MPI parallelisation

#### PsN

PsN must be able to perform:

- Model execution
- Bootstrap
- Stepwise covariate method (SCM)
- VPC
- SSE

#### R

R must be able to:

- Read in NONMEM/PsN outputs.
- Produce basic goodness of fit diagnostics

### SCP

SCP must have:

- reasonable run times
- reasonable queuing times
- no failures due to stability

## Testing plan

The testing plan is designed to provide a *reasonable* degree of assurance that the system accomplishes its intended requirements.

### Tests

List of tests and assessment criteria

- Bootstrap
- Stepwise covariate method (SCM)
- VPC
- SSE

#### Model execution tests

For each run, NONMEM will be executed via qpsn.  For each NONMEM run:

- OFV will be extracted from the psn.ext file using R
- basic goodness of fit diagnostics will be produced using R
- convergence diagnostics will be produced using R

Here is a list of tests, with assessment criteria list as sub-bullets:

1. (*run1.mod*) Theophylline PK (NONMEM installation test):
    - concordance of estimated OFV with vendor provided value
 
2. (*run2.mod*) Theophylline PK IMP:
    - approximate concordance of estimated OFV with run 1.
    - approximate concordance of basic goodness of fit diagnostics with run 1.

3. (*run3.mod*) Theophylline PK SAEM:
    - approximate concordance of estimated OFV with run 1.
    - approximate concordance of basic goodness of fit diagnostics with run 1.

4. (*run4.mod*) Theophylline PK IMP ODE:
    - close concordance of estimated OFV with run 2.
    - close concordance of convergence diagnostics with run 2.
    - close concordance of basic goodness of fit diagnostics with run 2.
    
5. (*run5.mod*) Theophylline PK IMP (larger dataset = THEOPPlarge.csv)
    - concordance of parameter estimates with run 2
    - concordance of basic goodness of fit diagnostics with run 2 but with larger file size.

6. (*run6.mod*) Theophylline PK IMP (larger dataset = THEOPPlarge.csv) parallelised with "-c auto"
    - Number of cores selected
    - concordance of OFV with run 5
    - concordance of basic goodness of fit diagnostics as run 5
    - consistency of results under repetition (repeat test 5 times concurrently)

#### Reliability tests

7. Run *run6.mod* 100 times
    - All runs should succeed

#### Parallel processing 

8. Run *run6.mod* under different levels of parallelisation
    - Success rate
    - queuing times
    - run times

9. Bootstrap *run6.mod*
    - Success rate

#### Bootstrap tests

1. (*run2.mod*) Bootstrap -samples=10
    - raw results produced with 10 rows
    - boostrap_results produced


## Results

### Model execution results

```{r echo=FALSE, message=FALSE, results='hide', warning=FALSE}
level <- params$level
source("Scripts/nm.log2.R")
```

This was run with module

```{r}
module_cmd()
```


```{r}
kable(summary(ds$m) %>% 
        select(run_id, status, ofv:cond_num))
```

```{r, warning=FALSE}
ds$m[1] %>% gof_ggplot2()
```

```{r, warning=FALSE}
pl2 <- plot_job_run_times_nm(ds$m)
pl2[[6]]

```

    
#### Reliability tests

7. Run *run6.mod* 100 times
    - All runs should succeed

```{r}
kable(status_table(d6$m))

kable(s6 %>% select(run_id, status, ofv:cond_num) %>% head(10))
```

```{r, warning=FALSE}
p62 <- plot_job_run_times_nm(d6$m)
p62[[6]]
```

#### Parallel processing 

8. Run *run6.mod* under different levels of parallelisation
    - Success rate
    - queuing times
    - run times

```{r}
kable(status_table(dc$m))

kable(sc %>% select(run_id, status, ofv:cond_num) %>% head(5))

```

```{r, warning=FALSE}
pl <- plot_job_run_times(jobs = job_info(dc$m),
                         run_in = run_in(dc$m))
pl[[6]]
```



9. Bootstrap *run6.mod*
    - Success rate

```{r}

if(level > 1) {
  kable(status_table(m1boot))
} else "bootstrap skipped in level 1"

```

